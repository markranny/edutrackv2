<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <title>Markings</title>
  <link rel="stylesheet" href="marking.css"/>
</head>
<body>
  <div class="container">
    
    <aside class="sidebar">
      <div class="profile">
        <img src="assets/student1.png" alt="Student" />
        <h3 id="studentName">Student</h3>
      </div>
      <nav>
        <button class="marking-btn nav-item">Markings</button>
        <a href="analytics.html" class="nav-item active">Progress</a>
      </nav>
      <div class="logout">
        <a href="logout.html" class="logout-btn">
          <i class="fa-solid fa-right-from-bracket"></i>
        </a>
      </div>
    </aside>

    <main class="content">
      <h1>Markings</h1>
      <table id="gradesTable">
        <thead>
          <tr>
            <th>Subject</th>
            <th>1st Grading</th>
            <th>2nd Grading</th>
            <th>3rd Grading</th>
            <th>4th Grading</th>
            <th>Final Average</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody id="gradesTableBody">
          <!-- Grades will be populated by JavaScript -->
        </tbody>
      </table>
    
      <div class="grade-scale">
        <table class="grading-table">
          <thead>
            <tr>
              <th>DESCRIPTOR</th>
              <th>GRADING SCALE</th>
              <th>REMARKS</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Outstanding</td>
              <td>90–100</td>
              <td>Passed</td>
            </tr>
            <tr>
              <td>Very Satisfactory</td>
              <td>85–89</td>
              <td>Passed</td>
            </tr>
            <tr>
              <td>Satisfactory</td>
              <td>80–84</td>
              <td>Passed</td>
            </tr>
            <tr>
              <td>Fairly Satisfactory</td>
              <td>75–79</td>
              <td>Passed</td>
            </tr>
            <tr>
              <td>Did Not Meet Expectations</td>
              <td>Below 75</td>
              <td>Failed</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const profileDiv = document.querySelector(".profile");
      if (profileDiv) {
        profileDiv.addEventListener("click", function () {
          window.location.href = "profiles.html";
        });
      }

      // Get current student from session storage
      const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
      const studentName = currentUser.firstname ? `${currentUser.firstname} ${currentUser.lastname || ''}`.trim() : 'Student';
      
      // Update student name display
      document.getElementById('studentName').textContent = studentName;

      // Load and display student grades
      loadStudentGrades();

      function loadStudentGrades() {
  // Get current student from session storage
  const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
  
  // Create consistent student name
  let studentName = '';
  if (currentUser.firstname || currentUser.lastname) {
    studentName = `${currentUser.firstname || ''} ${currentUser.lastname || ''}`.trim();
  }
  
  if (!studentName) {
    console.warn('No student name found in session');
    return;
  }
  
  // Use normalized name for lookup
  const normalizedStudentName = studentName.toLowerCase();
  const studentGradesKey = `student_grades_${normalizedStudentName}`;
  
  const grades = JSON.parse(localStorage.getItem(studentGradesKey) || '{}');
  const tableBody = document.getElementById('gradesTableBody');
  
  // Clear existing rows
  tableBody.innerHTML = '';

  // Get all subjects from schedule
  const scheduleData = JSON.parse(localStorage.getItem('schedule') || '[]');
  const subjects = [...new Set(scheduleData.map(s => s.subject).filter(Boolean))];

  if (subjects.length === 0) {
    // Default subjects if no schedule found
    subjects.push('Mathematics', 'English', 'Science', 'History', 'GMRC');
  }

  let totalFinalAverage = 0;
  let subjectCount = 0;

  subjects.forEach(subject => {
    const row = document.createElement('tr');
    
    // Subject name
    const subjectCell = document.createElement('td');
    subjectCell.textContent = subject;
    row.appendChild(subjectCell);

    // Quarter grades
    const quarters = ['1st', '2nd', '3rd', '4th'];
    const quarterGrades = [];
    
    quarters.forEach(quarter => {
      const cell = document.createElement('td');
      const grade = grades[subject] && grades[subject][quarter] ? grades[subject][quarter] : null;
      
      if (grade !== null && grade > 0) {
        cell.textContent = grade.toFixed(1);
        quarterGrades.push(parseFloat(grade));
      } else {
        cell.textContent = '';
      }
      row.appendChild(cell);
    });

    // Calculate final average for this subject
    const finalAverage = quarterGrades.length > 0 ? 
      quarterGrades.reduce((sum, grade) => sum + grade, 0) / quarterGrades.length : 0;

    // Final Average cell
    const avgCell = document.createElement('td');
    if (finalAverage > 0) {
      avgCell.textContent = finalAverage.toFixed(1);
      totalFinalAverage += finalAverage;
      subjectCount++;
    } else {
      avgCell.textContent = '';
    }
    row.appendChild(avgCell);

    // Remarks cell
    const remarksCell = document.createElement('td');
    if (finalAverage > 0) {
      if (finalAverage >= 90) {
        remarksCell.textContent = 'Outstanding';
        remarksCell.className = 'passed';
      } else if (finalAverage >= 85) {
        remarksCell.textContent = 'Very Satisfactory';
        remarksCell.className = 'passed';
      } else if (finalAverage >= 80) {
        remarksCell.textContent = 'Satisfactory';
        remarksCell.className = 'passed';
      } else if (finalAverage >= 75) {
        remarksCell.textContent = 'Fairly Satisfactory';
        remarksCell.className = 'passed';
      } else {
        remarksCell.textContent = 'Did Not Meet Expectations';
        remarksCell.className = 'failed';
      }
    } else {
      remarksCell.textContent = '';
    }
    row.appendChild(remarksCell);

    tableBody.appendChild(row);
  });

  // Add General Average row if there are grades
  if (subjectCount > 0) {
    const genAvgRow = document.createElement('tr');
    genAvgRow.style.backgroundColor = '#e8f4f8';
    genAvgRow.style.fontWeight = 'bold';

    const genAvgLabel = document.createElement('td');
    genAvgLabel.textContent = 'GENERAL AVERAGE';
    genAvgRow.appendChild(genAvgLabel);

    // Empty cells for quarters
    for (let i = 0; i < 4; i++) {
      genAvgRow.appendChild(document.createElement('td'));
    }

    // General average calculation
    const generalAverage = totalFinalAverage / subjectCount;
    const genAvgCell = document.createElement('td');
    genAvgCell.textContent = generalAverage.toFixed(1);
    genAvgRow.appendChild(genAvgCell);

    // General remarks
    const genRemarksCell = document.createElement('td');
    if (generalAverage >= 75) {
      genRemarksCell.textContent = 'PASSED';
      genRemarksCell.className = 'passed';
    } else {
      genRemarksCell.textContent = 'FAILED';
      genRemarksCell.className = 'failed';
    }
    genAvgRow.appendChild(genRemarksCell);

    tableBody.appendChild(genAvgRow);
  }
}
    });
  </script>
</body>
</html>